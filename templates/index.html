<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyBloc - Block-Based Python Programming with Blockly</title>
    
    <!-- Blockly Core -->
    <script src="/static/blockly/blockly_compressed.js"></script>
    <script src="/static/blockly/blocks_compressed.js"></script>
    <script src="/static/blockly/en.js"></script>
    <!-- Blockly Python Generator -->
    <script src="/static/blockly/python_compressed.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 1em;
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #blocklyDiv {
            flex: 1;
            height: 100%;
        }

        .output-panel {
            width: 400px;
            background: #f8f9fa;
            border-left: 2px solid #e0e0e0;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .panel-header h2 {
            font-size: 1.2em;
            color: #333;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
            background: #e0e0e0;
            color: #333;
        }

        .btn-small:hover {
            background: #d0d0d0;
        }

        .code-content {
            background: #2d2d2d;
            color: #f8f8f2;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            min-height: 200px;
            max-height: 300px;
            overflow: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .output-content {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            min-height: 150px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
        }

        .success {
            color: #4caf50;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .error {
            color: #f44336;
            font-weight: bold;
            margin-bottom: 10px;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }
            
            #blocklyDiv {
                height: 400px;
            }
            
            .output-panel {
                width: 100%;
                border-left: none;
                border-top: 2px solid #e0e0e0;
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üêç PyBloc - Visual Python Programming</h1>
            <p class="subtitle">Snap blocks together to create Python code!</p>
        </header>

        <div class="main-content">
            <!-- Blockly Workspace -->
            <div id="blocklyDiv"></div>

            <!-- Output Panel -->
            <aside class="output-panel">
                <!-- Controls -->
                <div class="panel-section">
                    <div class="panel-header">
                        <h2>Controls</h2>
                    </div>
                    <div class="controls">
                        <button class="btn btn-primary" onclick="runCode()">‚ñ∂ Run Code</button>
                        <button class="btn btn-secondary" onclick="clearWorkspace()">üóë Clear</button>
                        <button class="btn btn-small" onclick="copyCode()">üìã Copy Code</button>
                    </div>
                </div>

                <!-- Generated Code -->
                <div class="panel-section">
                    <div class="panel-header">
                        <h2>Generated Python Code</h2>
                    </div>
                    <div id="codeDisplay" class="code-content"># Your code will appear here...</div>
                </div>

                <!-- Output -->
                <div class="panel-section">
                    <div class="panel-header">
                        <h2>Output</h2>
                    </div>
                    <div id="outputDisplay" class="output-content">Run your code to see output...</div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Blockly Toolbox Definition -->
    <xml id="toolbox" style="display: none">
        <category name="Basic" colour="#5b80a5">
            <block type="print">
                <value name="VALUE">
                    <shadow type="text">
                        <field name="TEXT">Hello, World!</field>
                    </shadow>
                </value>
            </block>
            <block type="comment"></block>
            <block type="variable">
                <value name="VALUE">
                    <shadow type="number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
            </block>
        </category>

        <category name="Math & Logic" colour="#5ba55b">
            <block type="math_op">
                <value name="LEFT">
                    <shadow type="number"><field name="NUM">1</field></shadow>
                </value>
                <value name="RIGHT">
                    <shadow type="number"><field name="NUM">1</field></shadow>
                </value>
            </block>
            <block type="comparison">
                <value name="LEFT">
                    <shadow type="number"><field name="NUM">1</field></shadow>
                </value>
                <value name="RIGHT">
                    <shadow type="number"><field name="NUM">1</field></shadow>
                </value>
            </block>
            <block type="logic_and">
                <value name="LEFT">
                    <shadow type="boolean"></shadow>
                </value>
                <value name="RIGHT">
                    <shadow type="boolean"></shadow>
                </value>
            </block>
            <block type="logic_or">
                <value name="LEFT">
                    <shadow type="boolean"></shadow>
                </value>
                <value name="RIGHT">
                    <shadow type="boolean"></shadow>
                </value>
            </block>
            <block type="logic_not">
                <value name="VALUE">
                    <shadow type="boolean"></shadow>
                </value>
            </block>
            <block type="random_number">
                <value name="MIN">
                    <shadow type="number"><field name="NUM">0</field></shadow>
                </value>
                <value name="MAX">
                    <shadow type="number"><field name="NUM">10</field></shadow>
                </value>
            </block>
        </category>

        <category name="Control Flow" colour="#e08b2c">
            <block type="if">
                <value name="CONDITION">
                    <shadow type="boolean"></shadow>
                </value>
            </block>
            <block type="if_else">
                <value name="CONDITION">
                    <shadow type="boolean"></shadow>
                </value>
            </block>
            <block type="for_loop">
                <value name="TIMES">
                    <shadow type="number"><field name="NUM">10</field></shadow>
                </value>
            </block>
            <block type="while_loop">
                <value name="CONDITION">
                    <shadow type="boolean"></shadow>
                </value>
            </block>
            <block type="break"></block>
            <block type="continue"></block>
        </category>

        <category name="Data Structures" colour="#8e44ad">
            <block type="create_list"></block>
            <block type="add_to_list">
                <value name="ITEM">
                    <shadow type="number"><field name="NUM">0</field></shadow>
                </value>
            </block>
            <block type="get_from_list">
                <value name="INDEX">
                    <shadow type="number"><field name="NUM">0</field></shadow>
                </value>
            </block>
            <block type="list_length"></block>
            <block type="create_dict"></block>
            <block type="set_dict_item">
                <value name="VALUE">
                    <shadow type="number"><field name="NUM">0</field></shadow>
                </value>
            </block>
            <block type="get_dict_item"></block>
        </category>

        <category name="Input/Output" colour="#16a085">
            <block type="get_input"></block>
            <block type="print_formatted"></block>
        </category>

        <category name="Advanced" colour="#c0392b">
            <block type="define_function"></block>
            <block type="call_function"></block>
            <block type="try_except"></block>
            <block type="wait">
                <value name="SECONDS">
                    <shadow type="number"><field name="NUM">1</field></shadow>
                </value>
            </block>
        </category>

        <category name="Values" colour="#5ba55b">
            <block type="number"></block>
            <block type="text"></block>
            <block type="boolean"></block>
            <block type="variable_ref"></block>
        </category>
    </xml>

    <!-- Custom Blocks and Generators -->
    <script src="/static/blockly_blocks.js"></script>
    <script src="/static/blockly_python.js"></script>

    <!-- Main Application Script -->
    <script>
        // Initialize Blockly workspace
        var workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            grid: {
                spacing: 20,
                length: 3,
                colour: '#ccc',
                snap: true
            },
            zoom: {
                controls: true,
                wheel: true,
                startScale: 1.0,
                maxScale: 3,
                minScale: 0.3,
                scaleSpeed: 1.2
            },
            trashcan: true,
            move: {
                scrollbars: {
                    horizontal: true,
                    vertical: true
                },
                drag: true,
                wheel: true
            }
        });

        // Update code display when blocks change
        function updateCodeDisplay() {
            try {
                var code = Blockly.Python.workspaceToCode(workspace);
                document.getElementById('codeDisplay').textContent = code || '# Your code will appear here...';
            } catch (error) {
                console.error('Error generating code:', error);
                document.getElementById('codeDisplay').textContent = '# Error generating code';
            }
        }

        // Listen for workspace changes
        workspace.addChangeListener(updateCodeDisplay);

        // Run the generated code
        async function runCode() {
            try {
                var code = Blockly.Python.workspaceToCode(workspace);
                
                if (!code || code.trim() === '') {
                    document.getElementById('outputDisplay').innerHTML = 
                        '<span class="error">No code to run!</span>';
                    return;
                }

                document.getElementById('outputDisplay').innerHTML = 
                    '<span style="color: #999;">Running code...</span>';

                const response = await fetch('/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code: code })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('outputDisplay').innerHTML = 
                        '<span class="success">‚úì Success!</span>\n' + escapeHtml(result.output);
                } else {
                    document.getElementById('outputDisplay').innerHTML = 
                        '<span class="error">‚úó Error!</span>\n' + escapeHtml(result.error);
                }
            } catch (error) {
                document.getElementById('outputDisplay').innerHTML = 
                    '<span class="error">‚úó Error!</span>\n' + escapeHtml(error.toString());
            }
        }

        // Clear the workspace
        function clearWorkspace() {
            if (confirm('Are you sure you want to clear the workspace?')) {
                workspace.clear();
                document.getElementById('outputDisplay').textContent = 'Run your code to see output...';
            }
        }

        // Copy generated code to clipboard
        function copyCode() {
            var code = Blockly.Python.workspaceToCode(workspace);
            if (!code || code.trim() === '') {
                alert('No code to copy!');
                return;
            }
            
            navigator.clipboard.writeText(code).then(function() {
                alert('Code copied to clipboard!');
            }).catch(function(err) {
                console.error('Failed to copy code:', err);
                alert('Failed to copy code');
            });
        }

        // Escape HTML for safe display
        function escapeHtml(text) {
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Initial code display update
        updateCodeDisplay();
    </script>
</body>
</html>
